<Project>

    <Target Name="CreateGitIgnore" BeforeTargets="PrepareForBuild">
        <WriteLinesToFile
            Condition="!Exists('$(ModuleWwwRootDirectory).gitignore')"
            File="$(ModuleWwwRootDirectory).gitignore"
            Lines="$(ModuleLazyDirectoryName)/;$(ModuleLazyManifestFile)"/>
    </Target>

    <Target Name="CleanBin" BeforeTargets="Clean;Rebuild;Build">
        <ItemGroup>
            <FilesToDelete Include="$(ModuleLazyDirectory)**/*.*" />
            <FilesToDelete Include="$(ModuleManifestPath)" />
        </ItemGroup>
        
        <RemoveDir Directories="$(ModuleLazyDirectory)" />
        <Delete Files="@(FilesToDelete)" />
    </Target>

    <!-- Ensure all DLLs and PDBs are available -->

    <Target Name="CopyDependencies" AfterTargets="Build">

        <PropertyGroup>
            <ProjectOutDir>$(MSBuildProjectDirectory)/$(OutDir)</ProjectOutDir>
        </PropertyGroup>

        <ItemGroup>
            <OutputFiles Include="$(ProjectOutDir)**/*.*" />
            <OutputFiles Include="@(ReferenceCopyLocalPaths)" />
        </ItemGroup>

        <Copy
            SourceFiles="@(OutputFiles)"
            DestinationFolder="$(ModuleLazyDirectory)"
            OverwriteReadOnlyFiles="true"
            SkipUnchangedFiles="false" />

    </Target>

    <!-- Create Lazy Manifest -->
    
    <UsingTask TaskName="GenerateManifest" AssemblyFile="$(_BLLNugetPackageBuildBinDirectory)ManifestGenerator.dll" />

    <Target Name="GenerateManifest" AfterTargets="CopyDependencies" Condition="$(BLLGenerateLazyManifest)">

        <PropertyGroup>
            <ProjectOutDir>$(MSBuildProjectDirectory)/$(OutDir)</ProjectOutDir>
        </PropertyGroup>

        <ItemGroup>
            <BLLManifestGeneratorAssemblyNames Include="@(ProjectReference->'%(Name)')" />
        </ItemGroup>

        <Message Importance="normal" Text="BLLManifestGeneratorAssemblyNames: @(BLLManifestGeneratorAssemblyNames)" />
        
        <GenerateManifest
            AssemblyNames="@(BLLManifestGeneratorAssemblyNames)"
            AssemblyPaths="$(ProjectOutDir);@(BLLManifestGeneratorAssemblyPaths)"
            ManifestOutputPath="$(ModuleManifestPath)" />

    </Target>

</Project>
